name: BTC K线测试（仅ubuntu-latest，修复语法错误）
on:
  workflow_dispatch:  # 手动触发
  schedule:
    - cron: '0 0 * * *'  # 定时执行（可选）

jobs:
  run-kline-script:
    runs-on: windows-latest-asia  # 仅用这个标签，秒级执行
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4
      
      - name: 设置Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: 安装requests库
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: 检查运行器信息+IP归属地（纯bash语法，无报错）
        run: |
          # 打印运行器基础信息
          echo "运行器系统：$RUNNER_OS"
          echo "运行器区域：$RUNNER_REGION"
          
          # 1. 获取公网IP（bash原生curl，兼容所有Linux）
          IP=$(curl -s --max-time 10 https://api.ipify.org)
          echo "出口IP：$IP"
          
          # 2. 获取IP归属地（用ip-api.com，比ipapi.co更稳定）
          if [ -n "$IP" ]; then
            GEO_INFO=$(curl -s --max-time 10 "http://ip-api.com/json/$IP?lang=zh-CN")
            echo "IP归属地信息："
            echo "$GEO_INFO" | jq .  # 格式化输出（GitHub runner内置jq）
          else
            echo "无法获取IP地址"
          fi
        shell: bash  # 强制bash，避免语法冲突
      
      - name: 执行BTC K线获取脚本
        run: python get_btc_kline.py
        shell: bash
