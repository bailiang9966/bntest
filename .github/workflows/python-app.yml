name: BTC K线测试（优先亚洲IP）
on:
  workflow_dispatch:  # 手动触发
  schedule:
    - cron: '0 0 * * *'  # 定时执行

jobs:
  run-kline-script:
    # 核心：优先级队列配置
    # 1. 首选：亚洲Ubuntu（ubuntu-latest-asia）
    # 2. 备选1：亚洲Windows（windows-latest-asia）
    # 3. 兜底：非美国通用Ubuntu（优先欧洲/亚洲节点）
    runs-on:
      - ubuntu-latest-asia
      - windows-latest-asia
      - ubuntu-latest
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4
      
      - name: 设置Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: 安装requests库（兼容Linux/Windows）
        run: |
          python -m pip install --upgrade pip
          pip install requests
        # Windows下自动用PowerShell执行，Linux用Bash，无需额外适配
      
      - name: 检查运行器信息+IP归属地（跨平台兼容）
        run: |
          # 打印运行器类型和区域（确认用了哪个标签）
          echo "运行器系统：$RUNNER_OS"
          echo "运行器区域：$RUNNER_REGION"
          
          # 跨平台获取公网IP（兼容Linux/Windows）
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            IP=$(curl -s https://api.ipify.org)
            echo "出口IP：$IP"
            # Linux下用jq解析IP归属地
            curl -s https://ipapi.co/$IP/json/ | jq .
          else
            # Windows下用PowerShell命令
            $IP = (Invoke-WebRequest -Uri https://api.ipify.org).Content
            echo "出口IP：$IP"
            (Invoke-WebRequest -Uri "https://ipapi.co/$IP/json/").Content | ConvertFrom-Json
          fi
        shell: bash  # 强制用Bash执行，简化跨平台逻辑
      
      - name: 执行BTC K线获取脚本
        run: python get_btc_kline.py
